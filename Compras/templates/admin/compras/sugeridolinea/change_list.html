{% extends "admin/change_list.html" %}
{% load humanize %}
{% load pivot_extras %}
{% load l10n %}

{% block result_list %}
  <style>
    :root { --thead-row1-h: 34px; }
    .kpi-wrap { display:flex; flex-wrap:nowrap; gap:6px; margin:4px 0 8px; overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable; }
    .kpi-card { flex:0 0 auto; min-width:150px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:6px 8px; }
    .kpi-wrap::-webkit-scrollbar { height:6px; } .kpi-wrap::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }
    .pivot-table-wrap { width:100%; overflow-x:auto; max-height:85vh; overflow-y:auto; position:relative; }
    .pivot-table { border-collapse:collapse; width:max-content; min-width:100%; margin-top:12px; table-layout:auto; }
    .pivot-table th, .pivot-table td { border:1px solid #ccc; padding:3px 5px; font-size:11.5px; line-height:1.1; white-space:nowrap; position:relative; }
    .pivot-table th { background:#f7f7f7; }
    .pivot-table thead tr:first-child th { position:sticky; top:0; z-index:2; }
    .pivot-table thead tr:nth-child(2) th { position:sticky; top:var(--thead-row1-h); z-index:1; }
    .pivot-table th.sticky-col, .pivot-table td.sticky-col { position:sticky; background:#fff; border-right:1px solid #ddd; }
    .pivot-table thead th.sticky-col { z-index:7; background:#f7f7f7; }
    .pivot-table thead tr:nth-child(1) th.sticky-col { z-index:7; }
    .pivot-table thead tr:nth-child(2) th.sticky-col { z-index:6; }
    .pivot-table tbody td.sticky-col { z-index:5; background:#fff; }
    .pivot-table thead th.group-head { z-index:1; }
    .pivot-table th.sticky-col-1, .pivot-table td.sticky-col-1 { left:0px;   min-width:50px; }
    .pivot-table th.sticky-col-2, .pivot-table td.sticky-col-2 { left:50px;  min-width:60px; }
    .pivot-table th.sticky-col-3, .pivot-table td.sticky-col-3 { left:135px; min-width:140px; }
    .pivot-table th.sticky-col-4, .pivot-table td.sticky-col-4 { left:275px; min-width:80px; border-right:2px solid #999; }
    .pivot-table input[type="number"], .pivot-table input[type="text"] { width:70px; padding:2px 4px; }
    .pivot-table input[type="submit"] { padding:1px 6px; font-size:12px; }
    .pivot-table input:focus { background:#ffffcc; outline:2px solid #007bff; }
    @media (max-width: 700px) {
      .kpi-wrap { grid-template-columns: repeat(2, 1fr); }
      .pivot-table th, .pivot-table td { font-size:10.5px; padding:2px 4px; }
      .pivot-table input[type="number"] { width:40px; }
    }
    td.stock-cell { background:#fff3cd; }
    td.sug-calc-cell { background:#d4edda; }
    th.group-head.alm-0 { background:#fdebd3; }
    th.group-head.alm-1 { background:#e8f6f3; }
    th.group-head.alm-2 { background:#eaf2f8; }
    th.group-head.alm-3 { background:#f5eef8; }
    th.group-head.alm-4 { background:#fef9e7; }

    /* Modal */
    .ms-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .ms-modal { background:#fff; border-radius:10px; width:min(520px, 92%); box-shadow:0 8px 24px rgba(0,0,0,.2); overflow:hidden; }
    .ms-modal__head { padding:14px 16px; background:#ffc107; color:#333; font-weight:600; }
    .ms-modal__body { padding:16px; color:#333; }
    .ms-modal__foot { padding:12px 16px; display:flex; gap:8px; justify-content:flex-end; background:#f7f7f7; }
    .ms-btn { padding:6px 12px; border-radius:6px; text-decoration:none; border:1px solid transparent; cursor:pointer; }
    .ms-btn--cancel { background:#fff; border-color:#ccc; color:#333; }
    .ms-btn--danger { background:#dc3545; color:#fff; }
    .ms-hidden { display:none; }
    .ms-modal-backdrop.show { display:flex; }

    td.clasificacion-i, td.clasificacion-c { background:#f8d7da; color:#721c24; font-weight:600; }
    td.clasificacion-d { background:#fff3cd; color:#856404; font-weight:600; }
    td.sugerido-cero { background:#e2e3e5; color:#6c757d; }

    /* Spinner para el botón del modal */
    .ms-btn--loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
      padding-right: 35px;
    }
    .ms-btn--loading::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      top: 50%;
      right: 10px;
      margin-top: -7px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spinner-modal 0.6s linear infinite;
    }
    @keyframes spinner-modal {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    (function () {
      function syncHeaderOffset() {
        const thead = document.querySelector('.pivot-table thead');
        if (!thead || !thead.rows || !thead.rows.length) return;
        const h = thead.rows[0].getBoundingClientRect().height;
        if (h && h > 0) {
          document.documentElement.style.setProperty('--thead-row1-h', Math.round(h) + 'px');
        }
      }
      window.addEventListener('load', syncHeaderOffset);
      window.addEventListener('resize', syncHeaderOffset);
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(syncHeaderOffset);
      }
      let lastW = window.innerWidth, lastH = window.innerHeight;
      setInterval(function(){
        if (lastW !== window.innerWidth || lastH !== window.innerHeight) {
          lastW = window.innerWidth; lastH = window.innerHeight; syncHeaderOffset();
        }
      }, 600);

      // Navegación con teclado SIMPLIFICADA
      document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.pivot-table');
        if (!table) return;

        let isNavigating = false;

        // Construir lista plana de todos los inputs editables
        function getAllInputs() {
          return Array.from(table.querySelectorAll('tbody input[type="number"]:not([disabled]), tbody input[type="text"]:not([disabled]), tbody input[type="checkbox"]:not([disabled])'));
        }

        // Navegar en la tabla
        function navigateTable(currentInput, direction) {
          if (isNavigating) return;
          isNavigating = true;

          try {
            const allInputs = getAllInputs();
            const currentIndex = allInputs.indexOf(currentInput);
            
            if (currentIndex === -1) return;

            let targetIndex = currentIndex;

            switch(direction) {
              case 'right':
              case 'enter':
                targetIndex = currentIndex + 1;
                if (targetIndex >= allInputs.length) {
                  targetIndex = allInputs.length - 1; // No saltar fuera del último
                }
                break;
                
              case 'left':
                targetIndex = currentIndex - 1;
                if (targetIndex < 0) {
                  targetIndex = 0; // No saltar fuera del primero
                }
                break;
                
              case 'down':
                // Buscar el siguiente input en una fila diferente
                const currentRow = currentInput.closest('tr');
                let found = false;
                for (let i = currentIndex + 1; i < allInputs.length; i++) {
                  const testRow = allInputs[i].closest('tr');
                  if (testRow !== currentRow) {
                    targetIndex = i;
                    found = true;
                    break;
                  }
                }
                if (!found) targetIndex = currentIndex; // Quedarse en el mismo
                break;
                
              case 'up':
                // Buscar el anterior input en una fila diferente
                const currentRowUp = currentInput.closest('tr');
                let foundUp = false;
                for (let i = currentIndex - 1; i >= 0; i--) {
                  const testRow = allInputs[i].closest('tr');
                  if (testRow !== currentRowUp) {
                    targetIndex = i;
                    foundUp = true;
                    break;
                  }
                }
                if (!foundUp) targetIndex = currentIndex; // Quedarse en el mismo
                break;
            }

            // Solo moverse si el índice cambió
            if (targetIndex !== currentIndex) {
              const targetInput = allInputs[targetIndex];
              
              if (targetInput) {
                // Hacer foco
                targetInput.focus();
                
                // Seleccionar texto si no es checkbox
                if (targetInput.type !== 'checkbox') {
                  targetInput.select();
                }
                
                // Scroll simple usando scrollIntoView nativo
                setTimeout(() => {
                  targetInput.scrollIntoView({ 
                    behavior: 'auto',  // Cambiar a 'auto' para evitar animaciones que causan problemas
                    block: 'nearest', 
                    inline: 'nearest' 
                  });
                }, 10);
              }
            }
          } finally {
            // Liberar el lock rápidamente
            setTimeout(() => {
              isNavigating = false;
            }, 100);
          }
        }

        // Event listener para navegación
        table.addEventListener('keydown', function(e) {
          const target = e.target;
          if (!target.matches('input[type="number"], input[type="text"], input[type="checkbox"]')) return;
          if (target.disabled || isNavigating) return;

          let handled = false;
          
          switch(e.key) {
            case 'ArrowRight':
              e.preventDefault();
              navigateTable(target, 'right');
              handled = true;
              break;
            case 'ArrowLeft':
              e.preventDefault();
              navigateTable(target, 'left');
              handled = true;
              break;
            case 'ArrowDown':
              e.preventDefault();
              navigateTable(target, 'down');
              handled = true;
              break;
            case 'ArrowUp':
              e.preventDefault();
              navigateTable(target, 'up');
              handled = true;
              break;
            case 'Enter':
              e.preventDefault();
              navigateTable(target, 'enter');
              handled = true;
              break;
          }
        });

        // Seleccionar contenido al hacer foco (más simple)
        table.addEventListener('focus', function(e) {
          if (e.target.matches('input[type="number"], input[type="text"]') && !isNavigating) {
            e.target.select();
          }
        }, true);
      });

      // Sistema de protección para clasificación I/C
      document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.pivot-table');
        if (!table) return;

        // Función para verificar y bloquear campos según clasificación
        function protegerCamposPorClasificacion() {
          const filas = table.querySelectorAll('tbody tr');
          
          filas.forEach(fila => {
            // Obtener todos los inputs de clasificación en la fila
            const inputsClasif = fila.querySelectorAll('input[name^="clasificacion_"]');
            
            inputsClasif.forEach(inputClasif => {
              const clasificacion = (inputClasif.value || '').trim().toUpperCase();
              const lineaId = inputClasif.name.split('_').pop();
              
              // Obtener los campos de descuento y último costo para esta línea
              const descuento1 = document.querySelector(`input[name="descuento_prov_pct_${lineaId}"]`);
              const descuento2 = document.querySelector(`input[name="descuento_prov_pct_2_${lineaId}"]`);
              const descuento3 = document.querySelector(`input[name="descuento_prov_pct_3_${lineaId}"]`);
              const ultimoCosto = document.querySelector(`input[name^="ultimo_costo_"][data-linea-id="${lineaId}"]`);
              
              // Si la clasificación es I o C, deshabilitar y resetear descuentos
              if (clasificacion === 'I' || clasificacion === 'C') {
                [descuento1, descuento2, descuento3].forEach(desc => {
                  if (desc && !desc.disabled) {
                    desc.disabled = true;
                    desc.value = '0';
                    desc.style.backgroundColor = '#e2e3e5';
                    desc.style.color = '#6c757d';
                  }
                });
                
                // NUEVO: Bloquear último costo solo para clasificación I
                if (clasificacion === 'I' && ultimoCosto && !ultimoCosto.disabled) {
                  ultimoCosto.disabled = true;
                  ultimoCosto.style.backgroundColor = '#e2e3e5';
                  ultimoCosto.style.color = '#6c757d';
                }
              } else {
                // Si no es I o C, habilitar los campos solo si estaban originalmente habilitados
                [descuento1, descuento2, descuento3].forEach(desc => {
                  if (desc && desc.hasAttribute('data-originally-enabled')) {
                    desc.disabled = false;
                    desc.style.backgroundColor = '';
                    desc.style.color = '';
                  }
                });
                
                // NUEVO: Habilitar último costo si estaba originalmente habilitado
                if (ultimoCosto && ultimoCosto.hasAttribute('data-originally-enabled')) {
                  ultimoCosto.disabled = false;
                  ultimoCosto.style.backgroundColor = '';
                  ultimoCosto.style.color = '';
                }
              }
            });
          });
        }

        // Marcar campos que originalmente estaban habilitados
        table.querySelectorAll('input[name^="descuento_prov_pct"], input[name^="ultimo_costo_"]').forEach(input => {
          if (!input.disabled) {
            input.setAttribute('data-originally-enabled', 'true');
          }
        });

        // Ejecutar al cargar
        protegerCamposPorClasificacion();

        // Ejecutar cuando cambie la clasificación
        table.addEventListener('change', function(e) {
          if (e.target.matches('input[name^="clasificacion_"]')) {
            protegerCamposPorClasificacion();
          }
        });

        // Ejecutar cuando se escriba en clasificación (para cambios en tiempo real)
        table.addEventListener('input', function(e) {
          if (e.target.matches('input[name^="clasificacion_"]')) {
            protegerCamposPorClasificacion();
          }
        });
      });

      // Formateo de moneda para último costo
      document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.pivot-table');
        if (!table) return;

        // Función para formatear número a moneda sin símbolo
        function formatearMoneda(valor) {
          if (!valor || isNaN(valor)) return '';
          return new Intl.NumberFormat('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(valor);
        }

        // Función para limpiar formato y obtener número - MEJORADA
        function limpiarNumero(texto) {
          if (!texto) return '';
          // Eliminar todos los puntos (separadores de miles) y comas
          return String(texto).replace(/\./g, '').replace(/,/g, '').trim();
        }

        // Manejar inputs de último costo
        table.addEventListener('focus', function(e) {
          if (e.target.matches('input[name^="ultimo_costo_"]')) {
            const valor = limpiarNumero(e.target.value);
            if (valor) {
              e.target.value = valor;
              // Guardar el valor limpio en un atributo data
              e.target.setAttribute('data-valor-limpio', valor);
            }
            e.target.select();
          }
        }, true);

        table.addEventListener('blur', function(e) {
          if (e.target.matches('input[name^="ultimo_costo_"]')) {
            const valor = limpiarNumero(e.target.value);
            if (valor && !isNaN(valor)) {
              e.target.setAttribute('data-valor-limpio', valor);
              e.target.value = formatearMoneda(valor);
            } else if (!valor) {
              e.target.value = '';
              e.target.removeAttribute('data-valor-limpio');
            }
          }
        }, true);

        // Permitir solo números mientras se escribe
        table.addEventListener('input', function(e) {
          if (e.target.matches('input[name^="ultimo_costo_"]')) {
            const valor = e.target.value;
            const limpio = valor.replace(/[^\d]/g, '');
            if (valor !== limpio) {
              const cursorPos = e.target.selectionStart;
              e.target.value = limpio;
              e.target.setSelectionRange(cursorPos - 1, cursorPos - 1);
            }
          }
        }, true);

        // Formatear todos los inputs al cargar
        table.querySelectorAll('input[name^="ultimo_costo_"]').forEach(input => {
          const valor = limpiarNumero(input.value);
          if (valor && !isNaN(valor)) {
            input.setAttribute('data-valor-limpio', valor);
            input.value = formatearMoneda(valor);
          }
        });

        // Antes de enviar el formulario, limpiar el formato
        const form = document.getElementById('pivot-form');
        if (form) {
          form.addEventListener('submit', function(e) {
            // Limpiar TODOS los inputs de ultimo_costo antes del submit
            table.querySelectorAll('input[name^="ultimo_costo_"]').forEach(input => {
              const valorLimpio = input.getAttribute('data-valor-limpio') || limpiarNumero(input.value);
              if (valorLimpio) {
                input.value = valorLimpio;
              }
            });
          });
        }
      });
    })();
  </script>

  {% if kpis %}
  <div class="kpi-wrap">
    <div class="kpi-card"><div class="kpi-title">Costo total</div><div class="kpi-value">${{ kpis.costo_total|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Unidades totales a pedir</div><div class="kpi-value">{{ kpis.total_unidades|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Cajas totales</div><div class="kpi-value">{{ kpis.total_cajas|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Artículos (filtrados)</div><div class="kpi-value">{{ kpis.total_articulos|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Costo sugerido proveedor</div><div class="kpi-value">${{ kpis.costo_sugerido_prov|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Costo sugerido interno</div><div class="kpi-value">${{ kpis.costo_sugerido_interno|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Gap prov vs calculado</div><div class="kpi-value">${{ kpis.gap_prov_vs_calc|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Gap interno vs calculado</div><div class="kpi-value">${{ kpis.gap_interno_vs_calc|floatformat:0|intcomma }}</div></div>
    <div class="kpi-card"><div class="kpi-title">Presupuesto total</div><div class="kpi-value">${{ kpis.presupuesto_total|floatformat:0|intcomma }}</div></div>
  </div>
  {% endif %}

  {% if lote_id_actual %}
    {% if not inputs_disabled %}
      <div style="margin:10px 0; display:flex; gap:8px; flex-wrap:wrap;">
        {% if es_proveedor and not ocultar_boton_confirmar_proveedor %}
          <a
            class="button"
            style="background:#007bff;color:#fff;padding:6px 12px;border-radius:4px;"
            href="{% url 'admin:confirmar_lote_proveedor' lote_id_actual %}"
            data-confirm="Al confirmar el sugerido no se puede deshacer. ¿Desea continuar?">
            Confirmar Sugerido
          </a>
        {% elif not es_proveedor %}
          <a
            class="button"
            style="background:#17a2b8;color:#fff;padding:6px 12px;border-radius:4px;"
            href="{% url 'admin:importar_a_icg' lote_id_actual %}"
            data-confirm="Importar a ICG generará la orden de pedido. Esta acción no se puede deshacer. ¿Desea continuar?">
            Importar a ICG
          </a>
          <a
            class="button"
            style="background:#6c757d;color:#fff;padding:6px 12px;border-radius:4px;"
            href="{% url 'admin:confirmar_pedido_icg' lote_id_actual %}"
            data-confirm="Marcar como COMPLETADO no se puede deshacer. ¿Desea continuar?">
            Confirmar Pedido ICG (Info)
          </a>
        {% endif %}
      </div>

      <div id="ms-confirm" class="ms-modal-backdrop">
        <div class="ms-modal">
          <div class="ms-modal__head">Confirmación requerida</div>
          <div class="ms-modal__body">
            <p id="ms-confirm-text" style="margin:0;"></p>
          </div>
          <div class="ms-modal__foot">
            <button type="button" class="ms-btn ms-btn--cancel" data-ms-cancel>Cancelar</button>
            <button type="button" class="ms-btn ms-btn--danger" data-ms-accept>Continuar</button>
          </div>
        </div>
      </div>

      <script>
        (function() {
          const modal = document.getElementById('ms-confirm');
          if (!modal) return;
          const txt = modal.querySelector('#ms-confirm-text');
          const btnCancel = modal.querySelector('[data-ms-cancel]');
          const btnAccept = modal.querySelector('[data-ms-accept]');
          let targetHref = null;
          let isProcessing = false;

          function openModal(message, href) {
            targetHref = href;
            txt.textContent = message || '¿Desea continuar?';
            modal.classList.add('show');
            isProcessing = false;
            btnAccept.disabled = false;
            btnAccept.classList.remove('ms-btn--loading');
            btnAccept.textContent = 'Continuar';
          }
          
          function closeModal() {
            modal.classList.remove('show');
            targetHref = null;
            isProcessing = false;
          }

          // Capturar clics en enlaces con data-confirm
          document.addEventListener('click', function(ev) {
            const link = ev.target.closest('a[data-confirm]');
            if (!link) return;
            
            ev.preventDefault();
            ev.stopPropagation();
            
            const message = link.getAttribute('data-confirm');
            const href = link.getAttribute('href');
            
            openModal(message, href);
          }, true);

          // Botón Cancelar
          if (btnCancel) {
            btnCancel.addEventListener('click', function(e) {
              e.preventDefault();
              if (!isProcessing) {
                closeModal();
              }
            });
          }
          
          // Botón Continuar/Aceptar
          if (btnAccept) {
            btnAccept.addEventListener('click', function(e) {
              e.preventDefault();
              
              // Prevenir múltiples clics
              if (isProcessing) {
                return;
              }
              
              if (!targetHref) {
                closeModal();
                return;
              }
              
              // Marcar como procesando
              isProcessing = true;
              
              // Agregar spinner y deshabilitar botón
              btnAccept.disabled = true;
              btnAccept.classList.add('ms-btn--loading');
              btnAccept.textContent = 'Procesando';
              
              // También deshabilitar el botón de cancelar
              btnCancel.disabled = true;
              
              // Navegar después de un pequeño delay
              setTimeout(function() {
                window.location.href = targetHref;
              }, 100);
            });
          }
          
          // Cerrar al hacer clic fuera del modal (solo si no está procesando)
          modal.addEventListener('click', function(ev) {
            if (ev.target === modal && !isProcessing) {
              closeModal();
            }
          });
          
          // Cerrar con ESC (solo si no está procesando)
          document.addEventListener('keydown', function(ev) {
            if (ev.key === 'Escape' && modal.classList.contains('show') && !isProcessing) {
              closeModal();
            }
          });
        })();
      </script>
    {% endif %}
  {% endif %}

  <form method="post" action="" id="pivot-form">
    {% csrf_token %}
    <div class="pivot-table-wrap">
      <table class="pivot-table">
        <thead>
          <tr>
            <th class="sticky-col sticky-col-1">Código</th>
            <th class="sticky-col sticky-col-2">Referencia</th>
            <th class="sticky-col sticky-col-3">Descripción</th>
            <th class="sticky-col sticky-col-4">Embalaje</th>
            <th>Último costo</th>
            <th>Desc. 1 %</th>
            <th>Desc. 2 %</th>
            <th>Desc. 3 %</th>
            {% for alm in almacenes_list %}
              <th class="group-head alm-{{ forloop.counter0 }}" colspan="7">{{ alm }}</th>
            {% endfor %}
            <th>Continuidad</th>
            <th>Nuevo nombre prov</th>
            <th>Observaciones prov</th>
            <th>Costo línea total</th>
          </tr>
          <tr>
            <th class="sticky-col sticky-col-1"></th>
            <th class="sticky-col sticky-col-2"></th>
            <th class="sticky-col sticky-col-3"></th>
            <th class="sticky-col sticky-col-4"></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            {% for alm in almacenes_list %}
              <th>Clasif.</th>
              <th>Stock</th>
              <th>Min</th>
              <th>Max</th>
              <th>Sug. calc</th>
              <th>Sug. prov</th>
              <th>Sug. interno</th>
            {% endfor %}
            <th></th><th></th><th></th><th></th>
          </tr>
        </thead>
        <tbody>
          {% for codigo, articulo_data in articulos_pivot.items %}
          <tr>
            <td class="sticky-col sticky-col-1">{{ codigo }}</td>
            <td class="sticky-col sticky-col-2">{% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.referencia }}{% endif %}{% endfor %}</td>
            <td class="sticky-col sticky-col-3">{% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.descripcion }}{% endif %}{% endfor %}</td>
            <td class="sticky-col sticky-col-4">{% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.embalaje|floatformat:0 }}{% endif %}{% endfor %}</td>
            <td>
              {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                {% with cls=articulo_data.clasificacion|default:'' %}
                  <input 
                    type="number" 
                    name="ultimo_costo_{{ ln.pk }}" 
                    value="{{ ln.ultimo_costo|floatformat:0 }}" 
                    step="1" 
                    min="0"
                    style="width:90px;"
                    {% if inputs_disabled or cls == 'I' %}disabled{% endif %} 
                    data-linea-id="{{ ln.pk }}" 
                  />
                {% endwith %}
              {% endif %}{% endfor %}
            </td>
            <td>
              {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                {% with cls=articulo_data.clasificacion|default:'' %}
                  <input type="number" name="descuento_prov_pct_{{ ln.pk }}" value="{{ ln.descuento_prov_pct|default_if_none:''|floatformat:0 }}" step="1" {% if inputs_disabled or cls == 'I' or cls == 'C' %}disabled{% endif %} data-linea-id="{{ ln.pk }}" />
                {% endwith %}
              {% endif %}{% endfor %}
            </td>
            <td>
              {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                {% with cls=articulo_data.clasificacion|default:'' %}
                  <input type="number" name="descuento_prov_pct_2_{{ ln.pk }}" value="{{ ln.descuento_prov_pct_2|default_if_none:''|floatformat:0 }}" step="1" {% if inputs_disabled or cls == 'I' or cls == 'C' %}disabled{% endif %} data-linea-id="{{ ln.pk }}" />
                {% endwith %}
              {% endif %}{% endfor %}
            </td>
            <td>
              {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                {% with cls=articulo_data.clasificacion|default:'' %}
                  <input type="number" name="descuento_prov_pct_3_{{ ln.pk }}" value="{{ ln.descuento_prov_pct_3|default_if_none:''|floatformat:0 }}" step="1" {% if inputs_disabled or cls == 'I' or cls == 'C' %}disabled{% endif %} data-linea-id="{{ ln.pk }}" />
                {% endwith %}
              {% endif %}{% endfor %}
            </td>

            {% for alm in almacenes_list %}
              {% with linea=articulo_data.lineas|dict_get:alm %}
                {% if linea %}
                  {# ========= CLASIFICACIÓN: I y C bloqueadas, C solo editable por interno ========= #}
                  <td {% with cls=linea.clasificacion|default_if_none:''|upper %}{% if cls == 'I' or cls == 'C' %}class="clasificacion-{{ cls|lower }}"{% elif cls == 'D' %}class="clasificacion-d"{% endif %}{% endwith %}>
                    {% if es_interno %}
                      {% with cls=linea.clasificacion|default_if_none:''|upper %}
                        <input
                          type="text"
                          name="clasificacion_{{ linea.pk }}"
                          value="{{ linea.clasificacion|default_if_none:'' }}"
                          maxlength="2"
                          style="width:50px;text-transform:uppercase;"
                          {% if inputs_disabled or cls == 'I' %}disabled{% endif %}
                        />
                      {% endwith %}
                    {% else %}
                      {{ linea.clasificacion }}
                    {% endif %}
                  </td>

                  {# ========= CAMPOS FIJOS ========= #}
                  <td class="stock-cell">{{ linea.stock_actual|floatformat:0 }}</td>
                  <td>{{ linea.stock_minimo|floatformat:0 }}</td>
                  <td>{{ linea.stock_maximo|floatformat:0 }}</td>
                    <td class="sug-calc-cell">
                    {% widthratio linea.stock_maximo 1 1 as max %}
                    {% widthratio linea.stock_actual 1 -1 as stock_neg %}
                    {{ max|add:stock_neg|floatformat:0 }}
                    </td>

                  {# ========= SUGERIDO PROVEEDOR: sin decimales ========= #}
                  <td {% with cls=linea.clasificacion|default_if_none:''|upper %}{% if cls == 'I' %}class="sugerido-cero"{% endif %}{% endwith %}>
                    {% if es_proveedor %}
                      {% with cls=linea.clasificacion|default_if_none:''|upper %}
                        {% if cls == 'I' %}
                          <input type="number" name="nuevo_sugerido_prov_{{ linea.pk }}" value="0" step="1" disabled />
                        {% elif cls == 'A' or cls == 'B' or cls == 'D' %}
                          <input
                            type="number"
                            name="nuevo_sugerido_prov_{{ linea.pk }}"
                            value="{{ linea.nuevo_sugerido_prov|default_if_none:''|floatformat:0 }}"
                            step="1"
                            {% if inputs_disabled %}disabled{% endif %}
                          />
                        {% elif cls == 'C' %}
                          {# C muestra el valor del sugerido interno (solo lectura para proveedor) #}
                          <input
                            type="number"
                            name="nuevo_sugerido_prov_{{ linea.pk }}"
                            value="{{ linea.sugerido_interno|default_if_none:''|floatformat:0 }}"
                            step="1"
                            disabled
                          />
                        {% else %}
                          <input
                            type="number"
                            name="nuevo_sugerido_prov_{{ linea.pk }}"
                            value="{{ linea.nuevo_sugerido_prov|default_if_none:''|floatformat:0 }}"
                            step="1"
                            disabled
                          />
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      {% with cls=linea.clasificacion|default_if_none:''|upper %}
                        {% if cls == 'I' %}0{% else %}{{ linea.nuevo_sugerido_prov|default_if_none:''|floatformat:0 }}{% endif %}
                      {% endwith %}
                    {% endif %}
                  </td>

                  {# ========= SUGERIDO INTERNO: solo I va a 0, C es editable ========= #}
                  <td {% with cls=linea.clasificacion|default_if_none:''|upper %}{% if cls == 'I' %}class="sugerido-cero"{% endif %}{% endwith %}>
                    {% if es_interno %}
                      {% with cls=linea.clasificacion|default_if_none:''|upper %}
                        {% if cls == 'I' %}
                          <input type="number" name="sugerido_interno_{{ linea.pk }}" value="0" step="1" min="0" disabled />
                        {% else %}
                          <input
                            type="number"
                            name="sugerido_interno_{{ linea.pk }}"
                            value="{{ linea.sugerido_interno|default_if_none:''|floatformat:0 }}"
                            step="1"
                            min="0"
                            {% if inputs_disabled %}disabled{% endif %}
                          />
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      {% with cls=linea.clasificacion|default_if_none:''|upper %}
                        {% if cls == 'I' %}0{% else %}{{ linea.sugerido_interno|default_if_none:''|floatformat:0 }}{% endif %}
                      {% endwith %}
                    {% endif %}
                    <input type="hidden" name="linea_id_{{ linea.pk }}" value="{{ linea.pk }}" />
                  </td>
                {% else %}
                  <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                {% endif %}
              {% endwith %}
            {% endfor %}

            <td>
              {% if es_proveedor %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                  <input type="checkbox" name="continuidad_activo_{{ ln.pk }}" {% if ln.continuidad_activo %}checked{% endif %} {% if inputs_disabled %}disabled{% endif %} />
                {% endif %}{% endfor %}
              {% else %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.continuidad_activo }}{% endif %}{% endfor %}
              {% endif %}
            </td>
            <td>
              {% if es_proveedor %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                  <input type="text" name="nuevo_nombre_prov_{{ ln.pk }}" value="{{ ln.nuevo_nombre_prov|default_if_none:'' }}" {% if inputs_disabled %}disabled{% endif %} />
                {% endif %}{% endfor %}
              {% else %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.nuevo_nombre_prov|default_if_none:'' }}{% endif %}{% endfor %}
              {% endif %}
            </td>
            <td>
              {% if es_proveedor %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}
                  <input type="text" name="observaciones_prov_{{ ln.pk }}" value="{{ ln.observaciones_prov|default_if_none:'' }}" {% if inputs_disabled %}disabled{% endif %} />
                {% endif %}{% endfor %}
              {% else %}
                {% for ln in articulo_data.lineas.values %}{% if forloop.first %}{{ ln.observaciones_prov|default_if_none:'' }}{% endif %}{% endfor %}
              {% endif %}
            </td>
            <td>
              ${{ articulo_data.costo_total|floatformat:0|intcomma }}
            </td>
          </tr>
          {% endfor %}
        </tbody>


    </div>      </table>  </form>
{% endblock %}
